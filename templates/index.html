{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-primary" href="/add">+ Add Application</a>
    <div class="d-flex">
        <div class="dropdown me-2">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="statusFilter" data-bs-toggle="dropdown" aria-expanded="false">
                Filter by Status: {{ filter_status if filter_status else 'All' }}
            </button>
            <ul class="dropdown-menu" aria-labelledby="statusFilter">
                <li><a class="dropdown-item {% if not filter_status %}active{% endif %}" href="{{ url_for('index', sort_by=sort_by, order=order) }}">All</a></li>
                <li><a class="dropdown-item {% if filter_status == 'Applied' %}active{% endif %}" href="{{ url_for('index', status='Applied', sort_by=sort_by, order=order) }}">Applied</a></li>
                <li><a class="dropdown-item {% if filter_status == 'Interviewing' %}active{% endif %}" href="{{ url_for('index', status='Interviewing', sort_by=sort_by, order=order) }}">Interviewing</a></li>
                <li><a class="dropdown-item {% if filter_status == 'Offer' %}active{% endif %}" href="{{ url_for('index', status='Offer', sort_by=sort_by, order=order) }}">Offer</a></li>
                <li><a class="dropdown-item {% if filter_status == 'Rejected' %}active{% endif %}" href="{{ url_for('index', status='Rejected', sort_by=sort_by, order=order) }}">Rejected</a></li>
                <li><a class="dropdown-item {% if filter_status == 'Accepted' %}active{% endif %}" href="{{ url_for('index', status='Accepted', sort_by=sort_by, order=order) }}">Accepted</a></li>
            </ul>
        </div>
        <div class="dropdown me-2">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="sortBy" data-bs-toggle="dropdown" aria-expanded="false">
                Sort By: {{ sort_by.replace('_', ' ').title() if sort_by else 'Applied On' }}
            </button>
            <ul class="dropdown-menu" aria-labelledby="sortBy">
                <li><a class="dropdown-item {% if sort_by == 'company' %}active{% endif %}" href="{{ url_for('index', status=filter_status, sort_by='company', order=order) }}">Company</a></li>
                <li><a class="dropdown-item {% if sort_by == 'job_title' %}active{% endif %}" href="{{ url_for('index', status=filter_status, sort_by='job_title', order=order) }}">Job Title</a></li>
                <li><a class="dropdown-item {% if sort_by == 'status' %}active{% endif %}" href="{{ url_for('index', status=filter_status, sort_by='status', order=order) }}">Status</a></li>
                <li><a class="dropdown-item {% if sort_by == 'date_applied' %}active{% endif %}" href="{{ url_for('index', status=filter_status, sort_by='date_applied', order=order) }}">Applied On</a></li>
            </ul>
        </div>
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="orderBy" data-bs-toggle="dropdown" aria-expanded="false">
                Order: {{ order.title() if order else 'Descending' }}
            </button>
            <ul class="dropdown-menu" aria-labelledby="orderBy">
                <li><a class="dropdown-item {% if order == 'ASC' %}active{% endif %}" href="{{ url_for('index', status=filter_status, sort_by=sort_by, order='ASC') }}">Ascending</a></li>
                <li><a class="dropdown-item {% if order == 'DESC' %}active{% endif %}" href="{{ url_for('index', status=filter_status, sort_by=sort_by, order='DESC') }}">Descending</a></li>
            </ul>
        </div>
    </div>
</div>
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>Company</th>
<th>Job Title</th>
<th>Status</th>
<th>Applied On</th>
<th>Location</th>
<th>Source</th>
<th>Link</th>
<th>Notes</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
{% for job in jobs %}
<tr>
<td>{{ job.company }}</td>
<td>{{ job.job_title }}</td>
<td>
    <select class="form-select form-select-sm status-select" data-job-id="{{ job.id }}" data-original-status="{{ job.status }}">
        <option value="Applied" {% if job.status == 'Applied' %}selected{% endif %}>Applied</option>
        <option value="Interviewing" {% if job.status == 'Interviewing' %}selected{% endif %}>Interviewing</option>
        <option value="Offer" {% if job.status == 'Offer' %}selected{% endif %}>Offer</option>
        <option value="Rejected" {% if job.status == 'Rejected' %}selected{% endif %}>Rejected</option>
        <option value="Accepted" {% if job.status == 'Accepted' %}selected{% endif %}>Accepted</option>
    </select></td>
<td>{{ job.date_applied }}</td>
<td>{{ job.location if job.location else 'N/A' }}</td>
<td>{{ job.source if job.source else 'N/A' }}</td>
<td>
{% if job.application_link %}
<a href="{{ job.application_link }}" target="_blank">View</a>
{% else %}
N/A
{% endif %}
</td>
<td>{{ job.notes if job.notes else 'N/A' }}</td>
<td>
    <a href="{{ url_for('edit', job_id=job.id) }}" class="btn btn-warning btn-sm">Edit</a>
    <form action="{{ url_for('delete', job_id=job.id) }}" method="post" style="display:inline;">
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this job application?');">Delete</button>
    </form>
</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusColorMap = {
        'Applied': 'bg-primary text-white',
        'Interviewing': 'bg-info text-dark',
        'Offer': 'bg-success text-white',
        'Rejected': 'bg-danger text-white',
        'Accepted': 'bg-success text-white' // Same as Offer for now
    };

    function applyStatusColor(selectElement) {
        const currentStatus = selectElement.value;
        // Remove all existing color classes from the map
        Object.values(statusColorMap).forEach(cls => selectElement.classList.remove(...cls.split(' ')));
        // Add the new color class
        const colorClass = statusColorMap[currentStatus] || 'bg-secondary text-white'; // Default if not found
        selectElement.classList.add(...colorClass.split(' '));
    }

    document.querySelectorAll('.status-select').forEach(function(selectElement) {
        // Apply color on initial load
        applyStatusColor(selectElement);

        selectElement.addEventListener('change', function() {
            const jobId = this.dataset.jobId;
            const newStatus = this.value;
            const originalStatus = this.dataset.originalStatus; // Store for revert

            fetch(`/update_job_status/${jobId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Status updated successfully:', data);
                    // Update original status data attribute
                    this.dataset.originalStatus = newStatus;
                    applyStatusColor(this); // Apply new color
                } else {
                    console.error('Failed to update status:', data);
                    alert('Failed to update status: ' + data.message);
                    // Revert dropdown selection on failure
                    this.value = originalStatus;
                    applyStatusColor(this); // Reapply original color
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating status.');
                // Revert dropdown selection on failure
                this.value = originalStatus;
                applyStatusColor(this); // Reapply original color
            });
        });
    });
});
</script>
{% endblock %}
